
#include "test.h"
#include "../dhcp.h"
#include "../udp.h"
#include "../mac.h"

extern NetworkInterface ni;
extern uint8_t sendBuffer[5000];
extern uint32_t sendBufferLength;

static char* dhcp_test_packet();

char* dhcp_test() {
  mu_run_test(dhcp_test_packet);
  return NULL;
}

static char* dhcp_test_packet() {
  uint8_t expectedBytes[] = {
    0x01, // op
    0x01, // hardwareType
    0x06, // hardwareAddrLen
    0x00, // hops
    0x01, 0x02, 0x03, 0x04, // transactionId
    0x00, 0x00, // secondsElapsed
    0x00, 0x00, // flags
    0x00, 0x00, 0x00, 0x00, // clientIpAddr
    0x00, 0x00, 0x00, 0x00, // yourIpAddr
    0x00, 0x00, 0x00, 0x00, // serverIpAddr
    0x00, 0x00, 0x00, 0x00, // gatewayIpAddr
    0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // clientHardwareAddress
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //overflowSpace
    0x63, 0x82, 0x53, 0x63, // magicCookie
    0x35, 0x01, 0x01, // message - discover
    0x37, 0x04, 0x01, 0x1c, 0x03, 0x06, // message - parameter request list
    0xff // message - end
  };

  uint32_t dhcpPacketOffset = sizeof(MAC_Header) + sizeof(IPV4_Header) + sizeof(UDP_Header);
  
  ni.dhcpData.transactionId = 0x01020303;
  DHCP_sendDiscover(&ni);
  mu_assert_equals_byteArray(
    expectedBytes,
    sizeof(expectedBytes),
    sendBuffer + dhcpPacketOffset,
    sendBufferLength - dhcpPacketOffset
  );
  return NULL;
}
